#!/usr/bin/env lua
-- Copyright Â© 2020 Fern Zapata
-- This Source Code Form is subject to the terms of the ISC License.
-- If a copy of the license was not distributed with this file, you
-- can obtain one at https://opensource.org/licenses/ISC/.

local lgi = require('lgi')
local GLib, Gio = lgi.GLib, lgi.Gio


local opened = 0
local code = 0


local function uri_cb(source, result)
  local suc, err = Gio.AppInfo.launch_default_for_uri_finish(result)
  if not suc then
    code = code + 1
    print('Error:', err.message)
  end
  opened = opened - 1
end


function main(args)
  for _, uri in pairs(args) do
    if not GLib.uri_parse_scheme(uri) then
      uri = Gio.File.new_for_commandline_arg(uri):get_uri()
    end
    Gio.AppInfo.launch_default_for_uri_async(uri, nil, nil, uri_cb)
    opened = opened + 1
  end

  while opened > 0 do
    GLib.MainContext.default():iteration()
  end

  return code
end


os.exit(main({...}))
